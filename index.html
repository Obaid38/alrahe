<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alrahe Label Manager</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F9F5EB">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* v1.0 Theme Styles */
        body { background-color: #F9F5EB; font-family: 'Lato', sans-serif; color: #5D4037; }
        .nav-active { color: #C9A66B; border-top: 2px solid #C9A66B; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #C9A66B; color: white; font-weight: bold; border-radius: 0.75rem; }
        .btn-dark { background-color: #5D4037; color: white; font-weight: bold; border-radius: 0.5rem; }
        
        /* Table Styles for "Excel" look */
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .excel-table th { background: #5D4037; color: white; padding: 8px; text-align: left; text-transform: uppercase; }
        .excel-table td { border-bottom: 1px solid #E5E7EB; padding: 8px; background: white; }
        .excel-table tr:nth-child(even) td { background: #FAFAF9; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div class="bg-[#3E2723] text-[#F9F5EB] p-4 text-center shadow-lg z-20">
        <h1 class="font-serif text-xl tracking-[0.2em] font-bold">ALRAHE LABEL</h1>
    </div>

    <div id="main-container" class="flex-1 overflow-y-auto p-4 pb-24">

        <div id="view-dashboard" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="card p-4">
                    <p class="text-xs uppercase text-gray-400 font-bold">Total Sales</p>
                    <h3 class="text-xl font-bold text-[#C9A66B]" id="kpi-sales">Rs. 0</h3>
                </div>
                <div class="card p-4">
                    <p class="text-xs uppercase text-gray-400 font-bold">Net Profit</p>
                    <h3 class="text-xl font-bold text-green-600" id="kpi-profit">Rs. 0</h3>
                </div>
            </div>
            
            <div class="card p-4">
                <h3 class="text-sm font-bold mb-4">Items Sold by Dress</h3>
                <canvas id="chart-items"></canvas>
            </div>
            
            <button onclick="document.getElementById('expense-modal').classList.remove('hidden')" class="w-full btn-dark py-3 shadow">
                + Add Expense
            </button>
        </div>

        <div id="view-new" class="hidden space-y-4">
            
            <div class="flex justify-end">
                <button onclick="openSettings()" class="text-xs font-bold text-[#5D4037] bg-white border border-[#C9A66B] px-3 py-1 rounded-full">
                    <i class="fa-solid fa-cog"></i> Price Settings
                </button>
            </div>

            <div class="card p-5 border-t-4 border-[#C9A66B]">
                <h2 class="text-lg font-bold mb-4">New Order</h2>
                <form id="order-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="ord-date" class="w-full p-2 border rounded bg-[#F9F5EB]">
                        <input type="text" id="ord-client" placeholder="Client Name" class="w-full p-2 border rounded bg-[#F9F5EB]">
                    </div>

                    <div id="items-list" class="space-y-3">
                        </div>
                    
                    <button type="button" onclick="addItemRow()" class="text-xs text-[#C9A66B] font-bold uppercase">+ Add Another Dress</button>

                    <div class="pt-4 border-t">
                        <div class="flex justify-between mb-2">
                            <label class="font-bold">Total Amount</label>
                            <span id="grand-total" class="font-bold">0</span>
                        </div>
                        <input type="number" id="ord-advance" placeholder="Advance Payment" class="w-full p-3 border rounded border-[#C9A66B]" oninput="calcTotals()">
                        <div class="flex justify-between mt-2 text-sm font-bold text-gray-500">
                            <span>Remaining:</span>
                            <span id="ord-remaining" class="text-red-500">0</span>
                        </div>
                    </div>

                    <button type="submit" id="btn-submit" class="w-full btn-primary py-4 shadow-lg">SUBMIT ORDER</button>
                </form>
            </div>
        </div>

        <div id="view-list" class="hidden space-y-4">
            <input type="text" id="search" placeholder="Search Client..." class="w-full p-3 rounded-full border shadow-sm mb-2" onkeyup="renderOrders()">
            
            <div class="bg-white rounded-lg shadow overflow-x-auto">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Dress</th>
                            <th>Due</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 pb-6 z-30 shadow-inner">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-active flex flex-col items-center">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">DASHBOARD</span>
        </button>
        <button onclick="switchTab('new')" id="nav-new" class="text-gray-400 flex flex-col items-center">
            <i class="fa-solid fa-circle-plus text-xl mb-1"></i><span class="text-[10px] font-bold">NEW ORDER</span>
        </button>
        <button onclick="switchTab('list')" id="nav-list" class="text-gray-400 flex flex-col items-center">
            <i class="fa-solid fa-list text-xl mb-1"></i><span class="text-[10px] font-bold">ORDERS</span>
        </button>
    </div>

    <div id="expense-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-6">
            <h3 class="font-bold mb-4">Add Expense</h3>
            <input type="date" id="exp-date" class="w-full mb-3 p-2 border rounded">
            <input type="text" id="exp-desc" placeholder="Description" class="w-full mb-3 p-2 border rounded">
            <input type="number" id="exp-amount" placeholder="Amount" class="w-full mb-4 p-2 border rounded">
            <div class="flex gap-2">
                <button onclick="document.getElementById('expense-modal').classList.add('hidden')" class="w-1/2 py-2 border rounded">Cancel</button>
                <button onclick="saveExpense()" class="w-1/2 btn-dark py-2">Save</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 h-[70vh] flex flex-col">
            <h3 class="font-bold mb-4">Dress Prices</h3>
            <div id="settings-list" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
            <button onclick="addSettingRow()" class="text-xs text-[#C9A66B] font-bold mb-4">+ Add Dress Type</button>
            <div class="flex gap-2">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-1/2 py-2 border rounded">Close</button>
                <button onclick="saveSettings()" class="w-1/2 btn-dark py-2">Save Prices</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl p-6 overflow-y-auto max-h-[80vh]">
            <h3 class="font-bold mb-4 flex justify-between">
                <span>Edit Order</span>
                <span id="edit-id-disp" class="text-xs text-gray-400"></span>
            </h3>
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-old-dress">
            
            <div class="space-y-3 text-sm">
                <div><label class="font-bold text-xs text-gray-400">Date</label><input id="edit-date" type="date" class="w-full p-2 border rounded"></div>
                <div><label class="font-bold text-xs text-gray-400">Client</label><input id="edit-client" type="text" class="w-full p-2 border rounded"></div>
                <div><label class="font-bold text-xs text-gray-400">Dress</label>
                    <select id="edit-dress" class="w-full p-2 border rounded"></select>
                </div>
                <div><label class="font-bold text-xs text-gray-400">Status</label>
                    <select id="edit-status" class="w-full p-2 border rounded">
                        <option>Pending</option><option>Production</option><option>Delivered</option><option>Cancelled</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="font-bold text-xs text-gray-400">Price</label><input id="edit-price" oninput="calcEdit()" type="number" class="w-full p-2 border rounded"></div>
                    <div><label class="font-bold text-xs text-gray-400">Qty</label><input id="edit-qty" oninput="calcEdit()" type="number" class="w-full p-2 border rounded"></div>
                    <div><label class="font-bold text-xs text-gray-400">Advance</label><input id="edit-adv" oninput="calcEdit()" type="number" class="w-full p-2 border rounded"></div>
                </div>
                <div class="flex justify-between font-bold bg-gray-50 p-2 rounded">
                    <span>Total: <span id="edit-total">0</span></span>
                    <span class="text-red-500">Due: <span id="edit-due">0</span></span>
                </div>
            </div>
            
            <div class="flex gap-2 mt-4">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="w-1/2 py-2 border rounded">Cancel</button>
                <button onclick="saveEdit()" class="w-1/2 btn-primary py-2">Update</button>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 bg-green-800 text-white px-6 py-3 rounded shadow-xl z-50 flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-[#C9A66B]"></i><span id="toast-msg">Success</span>
    </div>

    <script>
        // ⚠️ REPLACE THIS URL
        const API_URL = "https://script.google.com/macros/s/AKfycbwfde7eBWLWjn9l93GpwrtoyHukR65GMejKiA_kSL2D0Erdz9zTnHU3M2lgeUwtrh0m/exec"; 
        
        let db = { orders: [], expenses: [], settings: [] };
        
        // --- INIT ---
        window.onload = () => {
            document.getElementById('ord-date').valueAsDate = new Date();
            document.getElementById('exp-date').valueAsDate = new Date();
            addItemRow(); // Default one row
            fetchData();
        };

        async function fetchData() {
            try {
                const res = await fetch(API_URL + "?action=getData");
                const data = await res.json();
                if(data.status === "success") {
                    db = data;
                    renderDashboard();
                    renderOrders();
                }
            } catch(e) { console.error(e); }
        }

        async function postData(payload) {
            return fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }).then(r => r.json());
        }

        function switchTab(tab) {
            ['dashboard', 'new', 'list'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('nav-active', 'text-[#C9A66B]');
                document.getElementById(`nav-${t}`).classList.add('text-gray-400');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('nav-active', 'text-[#C9A66B]');
            document.getElementById(`nav-${tab}`).classList.remove('text-gray-400');
            if(tab==='list') renderOrders();
        }

        // --- NEW ORDER ---
        function addItemRow() {
            // Populate dress dropdown from settings
            let opts = '<option disabled selected>Select Dress</option>';
            // Fallback if settings empty
            const list = db.settings.length ? db.settings : [{ 'Dress Name':'Nur', Price:0 }, { 'Dress Name':'Mehr', Price:0 }];
            list.forEach(s => opts += `<option value="${s['Dress Name']}">${s['Dress Name']}</option>`);

            const html = `
                <div class="item-row p-3 bg-gray-50 rounded border border-gray-200 relative">
                    <button onclick="this.parentElement.remove(); calcTotals()" class="absolute top-1 right-1 text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button>
                    <div class="flex justify-between mb-2">
                        <select class="w-2/3 p-2 border rounded bg-white item-dress" onchange="updateRowPrice(this)">${opts}</select>
                        <input type="number" value="1" class="w-1/4 p-2 border rounded text-center item-qty" oninput="calcTotals()">
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">Price: <span class="item-price">0</span></span>
                        <span class="font-bold text-[#C9A66B]">Total: <span class="item-total">0</span></span>
                    </div>
                </div>`;
            document.getElementById('items-list').insertAdjacentHTML('beforeend', html);
        }

        function updateRowPrice(el) {
            const dress = el.value;
            const setting = db.settings.find(s => s['Dress Name'] === dress);
            el.closest('.item-row').querySelector('.item-price').innerText = setting ? setting.Price : 0;
            calcTotals();
        }

        function calcTotals() {
            let g = 0;
            document.querySelectorAll('.item-row').forEach(r => {
                const p = parseFloat(r.querySelector('.item-price').innerText)||0;
                const q = parseFloat(r.querySelector('.item-qty').value)||0;
                const t = p*q;
                r.querySelector('.item-total').innerText = t;
                g += t;
            });
            const adv = parseFloat(document.getElementById('ord-advance').value)||0;
            document.getElementById('grand-total').innerText = g.toLocaleString();
            document.getElementById('ord-remaining').innerText = (g - adv).toLocaleString();
        }

        document.getElementById('order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerHTML = 'Saving...'; btn.disabled = true;

            const grand = parseFloat(document.getElementById('grand-total').innerText.replace(/,/g,''));
            const totalAdv = parseFloat(document.getElementById('ord-advance').value)||0;

            const items = [];
            document.querySelectorAll('.item-row').forEach(r => {
                const p = parseFloat(r.querySelector('.item-price').innerText);
                const q = parseFloat(r.querySelector('.item-qty').value);
                const t = parseFloat(r.querySelector('.item-total').innerText);
                const itemAdv = (t/grand)*totalAdv; // Split advance
                items.push({ dress: r.querySelector('.item-dress').value, unitPrice: p, qty: q, total: t, advance: itemAdv, remaining: t-itemAdv });
            });

            const res = await postData({
                type: 'createOrder',
                date: document.getElementById('ord-date').value,
                client: document.getElementById('ord-client').value,
                items: items
            });

            if(res.status==='success') {
                showToast("Saved: " + res.orderId);
                e.target.reset(); document.getElementById('items-list').innerHTML=''; addItemRow();
                fetchData();
            }
            btn.innerHTML = 'SUBMIT ORDER'; btn.disabled = false;
        });

        // --- MY ORDERS (TABLE) ---
        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');
            const term = document.getElementById('search').value.toLowerCase();
            tbody.innerHTML = '';
            
            db.orders.filter(o => o['Client Name'].toLowerCase().includes(term)).reverse().forEach(o => {
                const due = Math.round(o['Remaining Amount']);
                const statusColor = o.Status==='Delivered'?'text-green-600':(o.Status==='Pending'?'text-yellow-600':'text-gray-600');
                
                const tr = `
                    <tr class="border-b">
                        <td>${o['Order ID']}</td>
                        <td>${new Date(o.Date).toLocaleDateString()}</td>
                        <td class="font-bold">${o['Client Name']}</td>
                        <td>${o['Dress Name']}</td>
                        <td class="text-red-500 font-bold">${due}</td>
                        <td class="${statusColor} text-[10px] uppercase font-bold">${o.Status}</td>
                        <td>
                            <button onclick='openEdit(${JSON.stringify(o)})' class="text-[#5D4037] bg-gray-100 px-2 py-1 rounded text-xs hover:bg-gray-200">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', tr);
            });
        }

        // --- EDIT ORDER ---
        function openEdit(o) {
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-id').value = o['Order ID'];
            document.getElementById('edit-old-dress').value = o['Dress Name']; // Crucial for finding row
            document.getElementById('edit-id-disp').innerText = o['Order ID'];
            
            document.getElementById('edit-date').value = new Date(o.Date).toISOString().split('T')[0];
            document.getElementById('edit-client').value = o['Client Name'];
            document.getElementById('edit-status').value = o.Status;
            document.getElementById('edit-price').value = o['Unit Price'];
            document.getElementById('edit-qty').value = o.Quantity;
            document.getElementById('edit-adv').value = o['Advance Payment'];
            
            // Populate dress options
            const dSel = document.getElementById('edit-dress');
            dSel.innerHTML = '';
            (db.settings.length ? db.settings : [{ 'Dress Name': o['Dress Name'] }]).forEach(s => {
                dSel.innerHTML += `<option>${s['Dress Name']}</option>`;
            });
            dSel.value = o['Dress Name'];
            
            calcEdit();
        }

        function calcEdit() {
            const p = parseFloat(document.getElementById('edit-price').value)||0;
            const q = parseFloat(document.getElementById('edit-qty').value)||0;
            const a = parseFloat(document.getElementById('edit-adv').value)||0;
            document.getElementById('edit-total').innerText = p*q;
            document.getElementById('edit-due').innerText = (p*q)-a;
        }

        async function saveEdit() {
            const res = await postData({
                type: 'updateFull',
                id: document.getElementById('edit-id').value,
                oldDress: document.getElementById('edit-old-dress').value,
                date: document.getElementById('edit-date').value,
                client: document.getElementById('edit-client').value,
                dress: document.getElementById('edit-dress').value,
                status: document.getElementById('edit-status').value,
                price: document.getElementById('edit-price').value,
                qty: document.getElementById('edit-qty').value,
                total: document.getElementById('edit-total').innerText,
                advance: document.getElementById('edit-adv').value,
                remaining: document.getElementById('edit-due').innerText
            });
            if(res.status === 'success') {
                showToast("Order Updated");
                document.getElementById('edit-modal').classList.add('hidden');
                fetchData();
            }
        }

        // --- SETTINGS (PRICES) ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            const list = document.getElementById('settings-list');
            list.innerHTML = '';
            
            // If empty, seed dummy
            const data = db.settings.length ? db.settings : [{'Dress Name':'', Price:0, 'Profit Margin':0}];
            data.forEach(s => addSettingRow(s['Dress Name'], s.Price, s['Profit Margin']));
        }

        function addSettingRow(name='', price='', profit='') {
            const html = `
                <div class="flex gap-2 items-center s-row">
                    <input class="w-1/3 p-2 border rounded text-xs s-name" placeholder="Name" value="${name}">
                    <input class="w-1/3 p-2 border rounded text-xs s-price" type="number" placeholder="Price" value="${price}">
                    <input class="w-1/3 p-2 border rounded text-xs s-profit" type="number" placeholder="Profit" value="${profit}">
                </div>`;
            document.getElementById('settings-list').insertAdjacentHTML('beforeend', html);
        }

        async function saveSettings() {
            const rows = [];
            document.querySelectorAll('.s-row').forEach(r => {
                const n = r.querySelector('.s-name').value;
                if(n) rows.push([n, r.querySelector('.s-price').value, '', '', r.querySelector('.s-profit').value, '', '']);
            });
            const res = await postData({ type: 'savePrices', rows: rows });
            if(res.status==='success') {
                showToast("Prices Saved");
                document.getElementById('settings-modal').classList.add('hidden');
                fetchData();
            }
        }

        // --- UTILS ---
        function saveExpense() {
            // ... (Same as v1.0 logic, omitted for brevity, add if needed)
            document.getElementById('expense-modal').classList.add('hidden');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(()=>t.classList.add('hidden'), 3000);
        }
        // --- DASHBOARD (Basic) ---
        function renderDashboard() {
            // Calc Metrics
            const sales = db.orders.reduce((s,o)=>s+(o['Total Amount']||0),0);
            const exps = db.expenses.reduce((s,e)=>s+(e.Amount||0),0);
            
            // Calc Profit (Margin * Qty) - Expenses
            let gross = 0;
            db.orders.forEach(o => {
                const s = db.settings.find(x => x['Dress Name'] === o['Dress Name']);
                if(s) gross += (s['Profit Margin'] * o.Quantity);
            });

            document.getElementById('kpi-sales').innerText = "Rs. "+sales.toLocaleString();
            document.getElementById('kpi-profit').innerText = "Rs. "+(gross-exps).toLocaleString();
            
            // Chart
            const counts = {};
            db.orders.forEach(o => counts[o['Dress Name']] = (counts[o['Dress Name']]||0)+o.Quantity);
            new Chart(document.getElementById('chart-items'), {
                type: 'bar',
                data: { labels: Object.keys(counts), datasets: [{ label:'Units', data:Object.values(counts), backgroundColor:'#C9A66B' }] }
            });
        }
    </script>
</body>
</html>